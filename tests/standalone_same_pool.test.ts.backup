import * as anchor from "@coral-xyz/anchor";
import { Program, BN } from "@coral-xyz/anchor";
import { KedolikCpSwap } from "../target/types/kedolik_cp_swap";
import {
  Keypair,
  PublicKey,
  SystemProgram,
} from "@solana/web3.js";
import {
  TOKEN_PROGRAM_ID,
  createMint,
  createAssociatedTokenAccount,
  mintTo,
  getAccount,
  getAssociatedTokenAddressSync,
} from "@solana/spl-token";
import {
  setupDepositTest,
  createProtocolTokenConfig,
  swapBaseInputWithProtocolToken,
  swap_base_input,
} from "./utils/instruction";
import { getProtocolTokenConfigAddress, getAmmConfigAddress } from "./utils/pda";
import { assert } from "chai";

describe("ðŸŽ¯ STANDALONE: Same Pool - Both Swap Types", () => {
  anchor.setProvider(anchor.AnchorProvider.env());
  const admin = anchor.Wallet.local().payer;
  const program = anchor.workspace.KedolikCpSwap as Program<KedolikCpSwap>;
  const connection = anchor.getProvider().connection;

  let protocolTokenMint: PublicKey;
  let treasuryKeypair: Keypair;
  let treasuryTokenAccount: PublicKey;
  let userProtocolTokenAccount: PublicKey;
  let configAddress: PublicKey;
  let token0: PublicKey;
  let token1: PublicKey;
  let token0Program: PublicKey;
  let token1Program: PublicKey;
  let poolAddress: PublicKey;

  const confirmOptions = {
    skipPreflight: true,
  };

  before(async () => {
    console.log("\n" + "=".repeat(80));
    console.log("ðŸŽ¯ STANDALONE TEST: One Pool, Two Swap Types");
    console.log("=".repeat(80));
    console.log("This test runs in isolation to avoid conflicts with other tests.\n");

    // Create KEDOL token
    protocolTokenMint = await createMint(
      connection,
      admin,
      admin.publicKey,
      admin.publicKey,
      9,
      undefined,
      undefined,
      TOKEN_PROGRAM_ID
    );
    console.log(`âœ… KEDOL Mint: ${protocolTokenMint.toString()}`);

    // Create treasury
    treasuryKeypair = Keypair.generate();
    treasuryTokenAccount = await createAssociatedTokenAccount(
      connection,
      admin,
      protocolTokenMint,
      treasuryKeypair.publicKey,
      undefined,
      TOKEN_PROGRAM_ID
    );
    console.log(`âœ… Treasury: ${treasuryKeypair.publicKey.toString()}`);

    // Create protocol token config
    const discountRate = new BN(2000); // 20% discount
    const protocolTokenPerUsd = new BN(10_000_000); // 10 KEDOL per 1 USD

    await createProtocolTokenConfig(
      program,
      connection,
      admin,
      protocolTokenMint,
      discountRate,
      admin.publicKey,
      treasuryKeypair.publicKey,
      protocolTokenPerUsd,
      confirmOptions
    );
    console.log("âœ… Protocol token config created");

    // Create AMM Config with unique index
    const config_index = 99; // Use a unique index
    const [ammConfig] = await getAmmConfigAddress(config_index, program.programId);
    
    await program.methods
      .createAmmConfig(
        config_index,
        new BN(2500), // 0.25% trade fee
        new BN(200000), // 20% protocol fee rate
        new BN(0), // 0% fund fee rate
        new BN(0) // 0 SOL create pool fee
      )
      .accounts({
        owner: admin.publicKey,
        ammConfig: ammConfig,
        systemProgram: SystemProgram.programId,
      })
      .rpc(confirmOptions);
    
    configAddress = ammConfig;
    console.log(`âœ… AMM Config: ${configAddress.toString()}`);

    // Create ONE large pool
    const depositResult = await setupDepositTest(
      program,
      connection,
      admin,
      {
        config_index: config_index,
        tradeFeeRate: new BN(2500),
        protocolFeeRate: new BN(200000),
        fundFeeRate: new BN(0),
        create_fee: new BN(0),
      },
      { transferFeeBasisPoints: 0, MaxFee: 0 },
      confirmOptions,
      {
        initAmount0: new BN(1000000_000000000), // 1 million tokens
        initAmount1: new BN(1000000_000000000), // 1 million tokens
      }
    );

    token0 = depositResult.poolState.token0Mint;
    token1 = depositResult.poolState.token1Mint;
    token0Program = depositResult.poolState.token0Program;
    token1Program = depositResult.poolState.token1Program;
    poolAddress = depositResult.poolAddress;

    console.log(`âœ… Pool: ${poolAddress.toString()}`);
    console.log(`   Token0: ${token0.toString()}`);
    console.log(`   Token1: ${token1.toString()}`);
    console.log(`   Liquidity: 1,000,000 tokens each side\n`);

    // Create KEDOL account for user and mint tokens
    userProtocolTokenAccount = await createAssociatedTokenAccount(
      connection,
      admin,
      protocolTokenMint,
      admin.publicKey,
      undefined,
      TOKEN_PROGRAM_ID
    );

    await mintTo(
      connection,
      admin,
      protocolTokenMint,
      userProtocolTokenAccount,
      admin.publicKey,
      10000_000000000, // 10,000 KEDOL
      [],
      undefined,
      TOKEN_PROGRAM_ID
    );
    console.log("âœ… User KEDOL balance: 10,000 KEDOL\n");
  });

  it("âœ… Executes BOTH swap types on the SAME pool", async () => {
    console.log("=".repeat(80));
    console.log("ðŸ”„ TESTING: SAME POOL - BOTH SWAP TYPES");
    console.log("=".repeat(80));
    console.log(`Pool: ${poolAddress.toString()}\n`);

    // ============================================================================
    // SWAP 1: NORMAL SWAP
    // ============================================================================
    console.log("â”€".repeat(80));
    console.log("ðŸ“Š SWAP 1: NORMAL SWAP (Without KEDOL Discount)");
    console.log("â”€".repeat(80));

    const initialToken0_1 = await getAccount(
      connection,
      getAssociatedTokenAddressSync(token0, admin.publicKey, false, token0Program),
      undefined,
      token0Program
    );
    const initialToken1_1 = await getAccount(
      connection,
      getAssociatedTokenAddressSync(token1, admin.publicKey, false, token1Program),
      undefined,
      token1Program
    );

    console.log("ðŸ“Š Before Swap 1:");
    console.log(`   Token0: ${(Number(initialToken0_1.amount) / 1e9).toFixed(6)} tokens`);
    console.log(`   Token1: ${(Number(initialToken1_1.amount) / 1e9).toFixed(6)} tokens\n`);

    const amountIn1 = new BN(100_000000000); // 100 tokens
    console.log(`ðŸ’± Swapping: 100 tokens (Normal swap - 0.25% total fee)\n`);

    await swap_base_input(
      program,
      admin,
      configAddress,
      token0,
      token0Program,
      token1,
      token1Program,
      amountIn1,
      new BN(1),
      confirmOptions
    );

    const finalToken0_1 = await getAccount(
      connection,
      getAssociatedTokenAddressSync(token0, admin.publicKey, false, token0Program),
      undefined,
      token0Program
    );
    const finalToken1_1 = await getAccount(
      connection,
      getAssociatedTokenAddressSync(token1, admin.publicKey, false, token1Program),
      undefined,
      token1Program
    );

    const token0Spent_1 = Number(initialToken0_1.amount - finalToken0_1.amount) / 1e9;
    const token1Received_1 = Number(finalToken1_1.amount - initialToken1_1.amount) / 1e9;

    console.log("ðŸ“Š After Swap 1:");
    console.log(`   Token0: ${(Number(finalToken0_1.amount) / 1e9).toFixed(6)} tokens`);
    console.log(`   Token1: ${(Number(finalToken1_1.amount) / 1e9).toFixed(6)} tokens\n`);

    console.log("âœ… Swap 1 Results:");
    console.log(`   Input:  ${token0Spent_1.toFixed(6)} tokens`);
    console.log(`   Output: ${token1Received_1.toFixed(6)} tokens`);
    console.log(`   Fee:    ${(100 - token1Received_1).toFixed(6)} tokens (0.25%)`);
    console.log(`   Expected: ~99.75 tokens\n`);

    // ============================================================================
    // SWAP 2: DISCOUNT SWAP
    // ============================================================================
    console.log("â”€".repeat(80));
    console.log("ðŸŽ¯ SWAP 2: DISCOUNT SWAP (With KEDOL Discount)");
    console.log("â”€".repeat(80));
    console.log("âš ï¸  IMPORTANT: Using THE SAME POOL as Swap 1!\n");

    const initialToken0_2 = await getAccount(
      connection,
      getAssociatedTokenAddressSync(token0, admin.publicKey, false, token0Program),
      undefined,
      token0Program
    );
    const initialToken1_2 = await getAccount(
      connection,
      getAssociatedTokenAddressSync(token1, admin.publicKey, false, token1Program),
      undefined,
      token1Program
    );
    const initialKedolog_2 = await getAccount(
      connection,
      userProtocolTokenAccount,
      undefined,
      TOKEN_PROGRAM_ID
    );
    const initialTreasury_2 = await getAccount(
      connection,
      treasuryTokenAccount,
      undefined,
      TOKEN_PROGRAM_ID
    );

    console.log("ðŸ“Š Before Swap 2:");
    console.log(`   Token0: ${(Number(initialToken0_2.amount) / 1e9).toFixed(6)} tokens`);
    console.log(`   Token1: ${(Number(initialToken1_2.amount) / 1e9).toFixed(6)} tokens`);
    console.log(`   User KEDOL: ${(Number(initialKedolog_2.amount) / 1e9).toFixed(6)} KEDOL`);
    console.log(`   Treasury KEDOL: ${(Number(initialTreasury_2.amount) / 1e9).toFixed(6)} KEDOL\n`);

    const amountIn2 = new BN(100_000000000); // 100 tokens
    console.log(`ðŸ’± Swapping: 100 tokens (Discount swap - 0.20% in swap + 0.04% in KEDOL)\n`);

    await swapBaseInputWithProtocolToken(
      program,
      connection,
      admin,
      configAddress,
      token0,
      token1,
      token0Program,
      token1Program,
      amountIn2,
      new BN(1),
      protocolTokenMint,
      TOKEN_PROGRAM_ID,
      confirmOptions
    );

    const finalToken0_2 = await getAccount(
      connection,
      getAssociatedTokenAddressSync(token0, admin.publicKey, false, token0Program),
      undefined,
      token0Program
    );
    const finalToken1_2 = await getAccount(
      connection,
      getAssociatedTokenAddressSync(token1, admin.publicKey, false, token1Program),
      undefined,
      token1Program
    );
    const finalKedolog_2 = await getAccount(
      connection,
      userProtocolTokenAccount,
      undefined,
      TOKEN_PROGRAM_ID
    );
    const finalTreasury_2 = await getAccount(
      connection,
      treasuryTokenAccount,
      undefined,
      TOKEN_PROGRAM_ID
    );

    const token0Spent_2 = Number(initialToken0_2.amount - finalToken0_2.amount) / 1e9;
    const token1Received_2 = Number(finalToken1_2.amount - initialToken1_2.amount) / 1e9;
    const kedologSpent_2 = Number(initialKedolog_2.amount - finalKedolog_2.amount) / 1e9;
    const kedologToTreasury_2 = Number(finalTreasury_2.amount - initialTreasury_2.amount) / 1e9;

    console.log("ðŸ“Š After Swap 2:");
    console.log(`   Token0: ${(Number(finalToken0_2.amount) / 1e9).toFixed(6)} tokens`);
    console.log(`   Token1: ${(Number(finalToken1_2.amount) / 1e9).toFixed(6)} tokens`);
    console.log(`   User KEDOL: ${(Number(finalKedolog_2.amount) / 1e9).toFixed(6)} KEDOL`);
    console.log(`   Treasury KEDOL: ${(Number(finalTreasury_2.amount) / 1e9).toFixed(6)} KEDOL\n`);

    console.log("âœ… Swap 2 Results:");
    console.log(`   Input:  ${token0Spent_2.toFixed(6)} tokens`);
    console.log(`   Output: ${token1Received_2.toFixed(6)} tokens`);
    console.log(`   KEDOL Paid: ${kedologSpent_2.toFixed(6)} KEDOL`);
    console.log(`   Expected: ~99.80 tokens + 0.40 KEDOL\n`);

    // ============================================================================
    // COMPARISON
    // ============================================================================
    console.log("=".repeat(80));
    console.log("ðŸ“Š FINAL COMPARISON: Same Pool, Different Swap Methods");
    console.log("=".repeat(80));
    console.log(`Pool Address: ${poolAddress.toString()}\n`);

    console.log("â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”");
    console.log("â”‚                        SWAP COMPARISON                              â”‚");
    console.log("â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤");
    console.log("â”‚ Metric              â”‚ Normal Swap      â”‚ Discount Swap             â”‚");
    console.log("â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤");
    console.log(`â”‚ Input               â”‚ ${token0Spent_1.toFixed(6).padEnd(16)} â”‚ ${token0Spent_2.toFixed(6).padEnd(25)} â”‚`);
    console.log(`â”‚ Output (tokens)     â”‚ ${token1Received_1.toFixed(6).padEnd(16)} â”‚ ${token1Received_2.toFixed(6).padEnd(25)} â”‚`);
    console.log(`â”‚ KEDOL Paid        â”‚ ${"0.000000".padEnd(16)} â”‚ ${kedologSpent_2.toFixed(6).padEnd(25)} â”‚`);
    console.log(`â”‚ Extra Tokens        â”‚ ${"0.000000".padEnd(16)} â”‚ ${(token1Received_2 - token1Received_1).toFixed(6).padEnd(25)} â”‚`);
    console.log("â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n");

    const extraTokens = token1Received_2 - token1Received_1;
    console.log("ðŸ’¡ Key Findings:");
    console.log(`   âœ… Same pool used for both swaps: ${poolAddress.toString()}`);
    console.log(`   âœ… Normal swap: ${token1Received_1.toFixed(6)} tokens received`);
    console.log(`   âœ… Discount swap: ${token1Received_2.toFixed(6)} tokens received`);
    console.log(`   âœ… Benefit: ${extraTokens.toFixed(6)} MORE tokens with discount!`);
    console.log(`   âœ… KEDOL paid: ${kedologSpent_2.toFixed(6)} KEDOL`);
    console.log(`   âœ… Treasury received: ${kedologToTreasury_2.toFixed(6)} KEDOL\n`);

    console.log("ðŸŽ¯ CONCLUSION:");
    console.log("   âœ… ONE pool successfully handles BOTH swap types!");
    console.log("   âœ… Users can choose normal or discount swap on the SAME pool.");
    console.log("   âœ… This is production-ready and will work on mainnet!\n");
    console.log("=".repeat(80) + "\n");

    // Assertions
    assert.equal(token0Spent_1.toFixed(6), "100.000000", "Swap 1 should spend 100 tokens");
    assert.equal(token0Spent_2.toFixed(6), "100.000000", "Swap 2 should spend 100 tokens");
    
    assert.isTrue(
      token1Received_1 > 99.70 && token1Received_1 < 99.80,
      `Normal swap should receive ~99.75 tokens, got ${token1Received_1.toFixed(6)}`
    );
    
    assert.isTrue(
      token1Received_2 > 99.75 && token1Received_2 < 99.85,
      `Discount swap should receive ~99.80 tokens, got ${token1Received_2.toFixed(6)}`
    );
    
    assert.isTrue(
      token1Received_2 > token1Received_1,
      "Discount swap should give MORE tokens than normal swap"
    );
    
    assert.isTrue(
      Math.abs(kedologSpent_2 - 0.40) < 0.01,
      `Should pay ~0.40 KEDOL, paid ${kedologSpent_2.toFixed(6)}`
    );
    
    assert.equal(
      kedologSpent_2.toFixed(6),
      kedologToTreasury_2.toFixed(6),
      "Treasury should receive exactly what user paid"
    );
  });
});

